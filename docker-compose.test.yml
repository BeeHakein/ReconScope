version: "3.9"

# Isolated test environment — run with:
#   docker compose -f docker-compose.test.yml up --build --abort-on-container-exit

services:
  # ─── Test Database ──────────────────────────────────────
  test-db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=reconscope_test
      - POSTGRES_PASSWORD=reconscope_test
      - POSTGRES_DB=reconscope_test
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U reconscope_test"]
      interval: 3s
      timeout: 3s
      retries: 10
    tmpfs:
      - /var/lib/postgresql/data  # In-memory for speed

  # ─── Test Redis ─────────────────────────────────────────
  test-redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    command: ["redis-server", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 3s
      timeout: 3s
      retries: 10

  # ─── Backend Tests ──────────────────────────────────────
  test-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgresql+asyncpg://reconscope_test:reconscope_test@test-db:5432/reconscope_test
      - REDIS_URL=redis://test-redis:6379/0
      - SECRET_KEY=test-secret-key-not-for-production
      - DEBUG=true
      - TESTING=true
    depends_on:
      test-db:
        condition: service_healthy
      test-redis:
        condition: service_healthy
    command: pytest --cov=app tests/ -v
    volumes:
      - ./backend/app:/app/app
      - ./backend/tests:/app/tests

  # ─── Frontend Tests ─────────────────────────────────────
  test-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    command: npx vitest run
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/src/__tests__:/app/src/__tests__
